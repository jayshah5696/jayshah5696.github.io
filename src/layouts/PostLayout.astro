---
import BaseLayout from './BaseLayout.astro';
import FormattedDate from '../components/FormattedDate.astro';
import TagList from '../components/TagList.astro';
import readingTime from 'reading-time';

interface Props {
  title: string;
  date: Date;
  description: string;
  image?: string;
  tags: string[];
  body: string;
}

const { title, date, description, image, tags, body } = Astro.props;
const stats = readingTime(body);

// Generate TOC from markdown headings
const headingRegex = /^(#{2,3})\s+(.+)$/gm;
const headings: { depth: number; text: string; slug: string }[] = [];
let match;
while ((match = headingRegex.exec(body)) !== null) {
  const depth = match[1].length;
  const text = match[2]
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    .replace(/[*_`~]/g, '')
    .trim();
  const slug = text
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');
  headings.push({ depth, text, slug });
}

const showToc = headings.length > 3;
---

<BaseLayout title={title} description={description} image={image}>
  <article>
    <!-- Header — carved stone inscription -->
    <header class="mb-12">
      <div class="flex items-center gap-3 mb-5">
        <FormattedDate date={date} />
        <span class="text-sand-300 dark:text-carved-600 text-xs select-none" aria-hidden="true">&bull;</span>
        <span class="font-mono text-xs text-sand-500 dark:text-sand-500 tabular-nums">{stats.text}</span>
      </div>

      <h1 class="font-display text-3xl sm:text-4xl text-carved-950 dark:text-sand-50 leading-tight text-balance carved-heading">
        {title}
      </h1>

      <p class="mt-5 text-lg text-carved-600 dark:text-sand-400 leading-relaxed text-pretty">
        {description}
      </p>

      {tags.length > 0 && (
        <div class="mt-5">
          <TagList tags={tags} />
        </div>
      )}

      <div class="mt-10 rangoli-border"></div>
    </header>

    <!-- TOC (ultra-wide screens) — like a carved index panel -->
    {showToc && (
      <aside class="hidden 2xl:block fixed right-8 top-16 w-56 z-20">
        <nav class="text-xs border-l-2 border-sand-200 dark:border-carved-700 pl-4" aria-label="Table of contents">
          <h4 class="font-mono uppercase tracking-[0.15em] text-sand-400 dark:text-sand-600 mb-3 text-[10px]">On this page</h4>
          <ul class="space-y-2">
            {headings.map(({ depth, text, slug }) => (
              <li class:list={[depth === 3 && 'pl-3']}>
                <a
                  href={`#${slug}`}
                  class="text-sand-500 dark:text-sand-500 hover:text-terra dark:hover:text-terra-light transition-colors duration-200 line-clamp-2 leading-snug"
                >
                  {text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    )}

    <!-- Content -->
    <div class="prose prose-sandstone dark:prose-invert prose-lg max-w-none">
      <slot />
    </div>

    <!-- Footer — ascending back up the stepwell -->
    <footer class="mt-16 pt-8">
      <div class="rangoli-border mb-6"></div>
      <a
        href="/"
        class="inline-flex items-center gap-2 text-sm text-sand-500 dark:text-sand-400 hover:text-terra dark:hover:text-terra-light transition-colors duration-200 font-mono tracking-wide"
      >
        <svg class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        All posts
      </a>
    </footer>
  </article>
</BaseLayout>
