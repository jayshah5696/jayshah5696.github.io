---
import BaseLayout from './BaseLayout.astro';
import FormattedDate from '../components/FormattedDate.astro';
import readingTime from 'reading-time';

interface Props {
  title: string;
  date: Date;
  description: string;
  image?: string;
  tags?: string[];
  body: string;
}

const { title, date, description, image, tags = [], body } = Astro.props;
const readTime = readingTime(body);

// Generate TOC from raw markdown headings
const headingRegex = /^(#{2,3})\s+(.+)$/gm;
const headings: { depth: number; text: string; slug: string }[] = [];
let match;
while ((match = headingRegex.exec(body)) !== null) {
  const depth = match[1].length;
  const raw = match[2];
  // Strip markdown links and formatting
  const text = raw
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    .replace(/[*_`]/g, '')
    .trim();
  const slug = text
    .toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim();
  headings.push({ depth, text, slug });
}
---

<BaseLayout title={title} description={description} image={image}>
  <article>
    <header class="mb-10">
      <div class="flex items-center gap-2 text-sm text-ink-400 dark:text-ink-500 mb-4">
        <FormattedDate date={date} />
        <span class="text-ink-200 dark:text-ink-700">&middot;</span>
        <span>{readTime.text}</span>
      </div>

      <h1 class="font-display text-3xl sm:text-4xl font-medium text-ink-950 dark:text-ink-50 leading-snug text-balance">
        {title}
      </h1>

      <p class="mt-3 text-ink-400 dark:text-ink-500 text-pretty">
        {description}
      </p>

      {tags.length > 0 && (
        <div class="mt-4 flex items-center gap-2 text-xs text-ink-300 dark:text-ink-600">
          {tags.map((tag, i) => (
            <>
              {i > 0 && <span>&middot;</span>}
              <a href={`/tags/${tag}`} class="hover:text-accent dark:hover:text-accent-light transition-colors">
                {tag}
              </a>
            </>
          ))}
        </div>
      )}
    </header>

    <hr class="border-ink-100 dark:border-ink-800/50 mb-10" />

    <!-- Content + TOC -->
    <div class="relative">
      {headings.length > 3 && (
        <aside class="hidden 2xl:block absolute -right-64 top-0 w-52">
          <nav class="sticky top-10" aria-label="Table of contents">
            <p class="text-[0.7rem] font-medium uppercase tracking-widest text-ink-300 dark:text-ink-600 mb-3">
              On this page
            </p>
            <ul class="space-y-1 text-[0.8rem] leading-relaxed border-l border-ink-100 dark:border-ink-800/50">
              {headings.map((h) => (
                <li>
                  <a
                    href={`#${h.slug}`}
                    class:list={[
                      'block py-0.5 text-ink-400 dark:text-ink-500 hover:text-accent dark:hover:text-accent-light transition-colors -ml-px border-l border-transparent hover:border-accent',
                      h.depth === 3 ? 'pl-5' : 'pl-3',
                    ]}
                  >
                    {h.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}

      <div class="prose prose-ink dark:prose-invert max-w-none
                  prose-p:text-base prose-p:leading-[1.8]
                  prose-li:text-base prose-li:leading-[1.8]
                  prose-headings:font-display">
        <slot />
      </div>
    </div>

    <footer class="mt-16 pt-8 border-t border-ink-100 dark:border-ink-800/50">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-sm text-ink-400 dark:text-ink-500 hover:text-accent dark:hover:text-accent-light transition-colors"
      >
        <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        All posts
      </a>
    </footer>
  </article>
</BaseLayout>
